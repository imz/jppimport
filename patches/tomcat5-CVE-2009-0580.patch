Index: apache-tomcat-5.5.27-src/container/webapps/docs/changelog.xml
===================================================================
--- apache-tomcat-5.5.27-src/container/webapps/docs/changelog.xml	(revision 781378)
+++ apache-tomcat-5.5.27-src/container/webapps/docs/changelog.xml	(revision 781379)
@@ -76,6 +76,11 @@
         logging at the context level but the security policy prevents this.
         (markt/rjung)
       </fix>
+      <fix>
+        Fix an information disclosure vulnerability in a number of the Realms
+        that allowed user enumeration when using FORM authentication. This is
+        CVE-2009-0580. (markt)
+      </fix>
     </changelog>
   </subsection>
   <subsection name="Jasper">
Index: apache-tomcat-5.5.27-src/container/catalina/src/share/org/apache/catalina/realm/DataSourceRealm.java
===================================================================
--- apache-tomcat-5.5.27-src/container/catalina/src/share/org/apache/catalina/realm/DataSourceRealm.java	(revision 781378)
+++ apache-tomcat-5.5.27-src/container/catalina/src/share/org/apache/catalina/realm/DataSourceRealm.java	(revision 781379)
@@ -270,8 +270,9 @@
      */
     public Principal authenticate(String username, String credentials) {
     	
-    	// No user - can't possibly authenticate, don't bother the database then
-    	if (username == null) {
+    	// No user or no credentials
+        // Can't possibly authenticate, don't bother the database then
+    	if (username == null || credentials == null) {
     		return null;
     	}
         
Index: apache-tomcat-5.5.27-src/container/catalina/src/share/org/apache/catalina/realm/JDBCRealm.java
===================================================================
--- apache-tomcat-5.5.27-src/container/catalina/src/share/org/apache/catalina/realm/JDBCRealm.java	(revision 781378)
+++ apache-tomcat-5.5.27-src/container/catalina/src/share/org/apache/catalina/realm/JDBCRealm.java	(revision 781379)
@@ -393,9 +393,10 @@
                                                String username,
                                                String credentials) {
 
-        // No user - can't possibly authenticate
-        if (username == null) {
-            return (null);
+        // No user or no credentials
+        // Can't possibly authenticate, don't bother the database then
+        if (username == null || credentials == null) {
+            return null;
         }
 
         // Look up the user's credentials
Index: apache-tomcat-5.5.27-src/container/catalina/src/share/org/apache/catalina/realm/MemoryRealm.java
===================================================================
--- apache-tomcat-5.5.27-src/container/catalina/src/share/org/apache/catalina/realm/MemoryRealm.java	(revision 781378)
+++ apache-tomcat-5.5.27-src/container/catalina/src/share/org/apache/catalina/realm/MemoryRealm.java	(revision 781379)
@@ -147,7 +147,7 @@
             (GenericPrincipal) principals.get(username);
 
         boolean validated = false;
-        if (principal != null) {
+        if (principal != null && credentials != null) {
             if (hasMessageDigest()) {
                 // Hex hashes should be compared case-insensitive
                 validated = (digest(credentials)

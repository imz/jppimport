#!/usr/bin/perl -w

#use strict;
use warnings;
use Carp;
use Getopt::Long;
use File::Basename;
use RPM::Source::Editor;
use RPM::Source::Convert::Generic2ALT;
use RPM::Source::Convert::JPackage2ALT;

my ($jpprpm,$altrpm,$jppspec,$altspec,$hook,$changelog,$release,$nobz2);
my $jvm=5;
my $packager='auto';
my $verbose=1;
my $cleanup=0;
my $outputdir='.';
my $patchdir=dirname($0)."/patches";

my $result = GetOptions ("jpp=s" => \$jpprpm,
		      "alt=s"   => \$altrpm,
		      "jvm=s" => \$jvm,
		      "jppspec=s" => \$jppspec,
		      "altspec=s"   => \$altspec,
		      "outdir=s"   => \$outputdir,
		      "packager=s"   => \$packager,
		      "hook=s"   => \$hook,
		      "changelog=s"   => \$changelog,
		      "cleanup!"   => \$cleanup,
		      "release=s"   => \$release,
		      "nobz2"   => \$nobz2,
		      "verbose+"  => \$verbose);
my ($alt,$jpp);

if (! $jpprpm && ! $jppspec) {
    print "ERROR: one of --jpp | --jppspec is required!\n";
    print "options:
--jpp /path/to/jpackage.src.rpm
--alt /path/to/altlinux.src.rpm
--jppspec /path/to/jpackage.spec
--altspec /path/to/altlinux.spec
--hook /path/to/hook to be called on resulting spec file
--jvm jvm JVM required for the build. by default, it is java-1.4.2.
  values are: 4 5 6 4.2 5.0 6.0
--out /path/to/output_dir
--changelog '- message'
--release 'release' - if we need to adjust the package's release

usage examples:
* convert srpm:
jppimport --alt Sisyphus/antlr-2.7.6-alt1.src.rpm --jpp jpackage/1.7/generic/free/SRPMS/antlr-2.7.7-1jpp.src.rpm
* convert srpm without history:
jppimport --jpp jpackage/1.7/generic/free/SRPMS/antlr-2.7.7-1jpp.src.rpm --srpmdir ~/OUT
* convert spec:
jppimport --altspec antlr.spec --jppspec jpackage/1.7/generic/free/SPECS/antlr.spec
";
    exit (64);
}

$jpp=RPM::Source::Editor->new(
    SOURCERPM => $jpprpm, 
    SPECFILE=> $jppspec, 
    OUTPUTDIR=> $outputdir, 
    PATCHDIR=>$patchdir, 
    VERBOSE=> $verbose,
    CLEANUP=> $cleanup,
    CHANGELOG=>'- converted from JPackage by jppimport script',
    CONVERT::JPACKAGE::JVM=>$jvm,
    CONVERT::JPACKAGE::NOBZ2=>$nobz2, 
);

my $jpprel = $jpp->get_section('package','')->get_tag('Release');
my $jppver = $jpp->get_section('package','')->get_tag('Version');
# $jpprel_branch is used to keep branch of fedora or mandriva
my $jpprel_branch='';

# for fedora-based imports (hack :()
if ($jpprel=~/\%\{\?dist\}/) {
    $jpprel=~s/\%\{\?dist\}//;
    $jpprel=~s/jpp(\.\d+)?//;
    $jpprel_branch=$1 if $1;
    $jpprel.=q'jpp';
}

my $altrel="alt1";
if ($altrpm || $altspec) {
    $alt=RPM::Source::Editor->new(SOURCERPM => $altrpm, SPECFILE => $altspec, VERBOSE=> $verbose);
    $altrel = $alt->get_section('package','')->get_tag('Release');
    $altver = $alt->get_section('package','')->get_tag('Version');
    my $vercmp = `rpmvercmp $altver $jppver`;
    chomp $vercmp;
    $jpp->get_section('changelog')->set_body($alt->get_section('changelog')->get_body());
    if ($altrel=~/^alt([^_]+)_(.+jpp)(\d(?:\.\d)?)$/) {
	my $rel = $1;
	my $jppfrom = $2;
	my $jppdist= $3;
	# hack -- cleanup (undefined in jpp) macro in alt release:
	$rel=~s/.?\%\w+//g;
	$rel=~s/.?\%\{\w+\}+//g;
	print STDERR "new alt release: $jpprel $rel $jppfrom $jppdist\n" if $verbose>0;
	if ($rel=~/^0\./ or $vercmp != 0) {
	    $rel=1;
	} elsif ($jppfrom eq $jpprel) {
	    $rel=~/^(\d+)/;
	    $rel=$1+1;
	}
	$altrel='alt'.$rel;
    } else {
	$altrel=~s/.?\%\w+//g;
	$altrel=~s/.?\%\{\w+\}+//g;
	$altrel='alt1' if $altrel=~/^alt0\./ or $vercmp != 0;
    }
    if ($packager eq 'auto') {
	my $altpackager=$alt->get_section('package','')->get_tag('Packager');
	$packager=$altpackager if $altpackager;
    }
    $alt->cleanup();
}

# our -- hack ?
our $jpptoolsdir=dirname($0);
# for cross-references in hooks
push @INC, $jpptoolsdir."/hooks";

if (not $hook) {
    # looking for default hook
    my $name = $jpp->get_section('package','')->get_tag('Name');
    my $defhook="$jpptoolsdir/hooks/$name.pl";
    # macro_expansion should be here
    #print "looking for default hook $defhook\n";
    $hook = $defhook if (-e $defhook);
}

our @SPECHOOKS;
our @PREHOOKS;
our $spechook;
if ($hook) {
    require $hook;
    die "script $hook does not have a valid hook!\n" unless @PREHOOKS or @SPECHOOKS or $spechook;
    if (@PREHOOKS) {
	$jpp->{WARN_NOTAPPLIED}++;
	map {&$_($jpp,$alt)} @PREHOOKS;
	$jpp->{WARN_NOTAPPLIED}--;
    }
}

print STDERR "entering alt_generic_fixes\n" if $verbose>1;
&RPM::Source::Convert::Generic2ALT::alt_generic_fix($jpp);
print STDERR "done alt_generic_fixes\n" if $verbose>1;
&RPM::Source::Convert::JPackage2ALT::jpp_specific_fix($jpp);
print STDERR "done jpp_specific_fixes\n" if $verbose>1;

my $newrel = $altrel.$jpprel_branch."_".$jpprel;
if ($newrel=~/jpp$/) {
    if ($jvm and $jvm =~ /^4/) {
	$newrel .= "1.7";
    } elsif ($jvm and $jvm =~ /^5/) {
	$newrel .= "5";
    } elsif ($jvm and $jvm =~ /^6/) {
	$newrel .= "6";
    } else {
	$newrel .= "5";
    }
}

$newrel=$release if ($release);
$jpp->get_section('package','')->set_tag('Release',$newrel);

if ($hook) {
    if ($spechook or @SPECHOOKS) {
	$jpp->{WARN_NOTAPPLIED}++;
	map {&$_($jpp,$alt)} @SPECHOOKS;
	&$spechook($jpp,$alt) if $spechook;
	$jpp->{WARN_NOTAPPLIED}--;
    }
}

if ($changelog) {
    $jpp->set_changelog($changelog);
}

if ($packager eq 'auto') {
    $packager=$jpp->macros()->macro_subst('%{packager}');
}

if ($packager) {
    if ($packager ne 'none') {
	$jpp->get_section('package','')->set_tag('Packager',$packager);
    } else {
	$jpp->get_section('package','')->clear_tag('Packager');
    }
}

print $jpp->get_spec() if $jppspec or $verbose>1;
$jpp->write_rpm() if $jpprpm;
$jpp->cleanup();


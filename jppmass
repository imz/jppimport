#!/usr/bin/perl -w

use Carp;
use Getopt::Long;

my $verbose;
my $ALTPATH='~/hasher/repo/SRPMS.hasher:~/hasher/repo/SRPMS.hasher.0:~/hasher/repo/SRPMS.hasher.S:/var/ftp/pub/Linux/ALT/Sisyphus/files/apt-java-Sisyphus/SRPMS.java:/var/ftp/pub/Linux/ALT/Sisyphus/files/SRPMS:/var/ftp/pub/Linux/ALT/Sisyphus/orphaned';
my $JPPPATH='/var/ftp/pub/Linux/jpackage/1.7/generic/free/SRPMS';
my $OUTDIR="./OUT";
my $changelog;

my $result = GetOptions ("jpp=s" => \$JPPPATH,
		      "alt=s"   => \$ALTPATH,
		      "out=s" => \$OUTDIR,
		      "changelog=s"   => \$changelog,
		      "verbose"  => \$verbose);
my ($alt,$jpp);

if (! &is_valid_pathspec($ALTPATH) || ! &is_valid_pathspec($JPPPATH)) {
    print "usage [ options ] [ list of rpms/names ]
options:
--jpp /path/to/jpackage/src/RPMS:/other/path
--alt /path/to/altlinux/src/RPMS:/other/path1:/other/path2
--out /path/to/output_dir (default is $OUTDIR)

usage examples:
upgrade all alt java packages using jpackage
jppmass --alt /var/ftp/pub/Sisyphus/files/SRPMS --jpp /var/ftp/pub/jpackage/1.7/generic/free/SRPMS
";
    exit (64);
}

my @ALTPATH=&path_to_array($ALTPATH);
my @JPPPATH=&path_to_array($JPPPATH);

my $jpptoolsdir=&dirname($0);
my $jppimport="$jpptoolsdir/jppimport";

mkdir $OUTDIR unless -e $OUTDIR;

my @packages = @ARGV;
@packages = @ALTPKG if @packages == 0;

# hangs ... why?
my %JPPSKIP=map {$_ => 1} 
qw/easymockclassextension gnu-trove ht2html postgresql-jdbc jboss4-buildmagic-tasks/
;

&alt2jpp();
#&jppskipalt();

sub alt2jpp {
    foreach my $name (@packages) {
	next if $ALTSKIP{$name};
	my $altrpm="$ALTPATH/$name";
	if ($name=~/.src.rpm$/) {
	    $name=&get_rpm_name($altrpm);
	    next if $ALTSKIP{$name};
	} else {
	    $altrpm = &find_rpm($name, @ALTPATH);
	}
	$name=$ALT2JPPMAP{$name} if $ALT2JPPMAP{$name};
	my $jpprpm = &find_rpm($name, @JPPPATH);
#    print STDERR "found RPM $jpprpm for $name.\n";
	my $importcmd="$jppimport --srpmdir $OUTDIR";
	$importcmd.=" --changelog '$changelog'" if ($changelog);
	if ($altrpm) {
	    $importcmd.=" --alt $altrpm";
	} else {
	    print STDERR "WARNING: alt RPM $name not found.\n";
	}
	if ($jpprpm) {
	    $importcmd.=" --jpp $jpprpm";
	} else {
	    print STDERR "FATAL: jpp RPM $name not found.\n";
	    next;
	}
	my $hook="$jpptoolsdir/hooks/$name.pl";
	$importcmd.=" --hook $hook" if (-e $hook);
	print "$importcmd\n";
	print `$importcmd`,"---*---\n";
    }
}

sub jppskipalt {
    foreach my $name (@packages) {
	next if $JPPSKIP{$name};
	next if $JPP2ALTMAP{$name};
	my $altrpm = &find_rpm($name, &path_to_array($ALTPATH));
	next if $altrpm;
	my $jpprpm = &find_rpm($name, &path_to_array($JPPPATH));
#    print STDERR "found RPM $jpprpm for $name.\n";
	my $importcmd="$jppimport --srpmdir $OUTDIR";
	$importcmd.=" --changelog '$changelog'" if ($changelog);
	if ($jpprpm) {
	    $importcmd.=" --jpp $jpprpm";
	} else {
	    print STDERR "FATAL: jpp RPM $name not found.\n";
	    next;
	}
	my $hook="$jpptoolsdir/hooks/$name.pl";
	$importcmd.=" --hook $hook" if (-e $hook);
	print "$importcmd\n";
	print `$importcmd`,"---*---\n";
    }
}

sub path_to_array {
    my $paths=shift;
    my @path;
    foreach (split(':',$paths)) {
	if ($_ eq '') {
	    $_ = '.';
	} elsif (/^~/) {
	    s/^~/$ENV{HOME}/;
	}
	push @path, $_ if -d $_;
    }
    return @path;
}

sub is_valid_pathspec {
    return scalar &path_to_array(shift());
}

sub get_rpm_name {
    my $rpm=shift;
    my $name=`rpmquery --queryformat '\%{NAME}' -p $rpm`;
    chomp $name;
    return $name;
}

sub get_rpm_version {
    my $rpm=shift;
    my $name=`rpmquery --queryformat '\%{VERSION}' -p $rpm`;
    chomp $name;
    return $name;
}

sub rpmvercmp {
    return system ('rpmvercmp', shift(), shift());
}

sub find_rpm {
    my $name=shift;
    for my $path (@_) {
	for my $rpm (glob "$path/$name-*.src.rpm") {
#	print STDERR "trying $rpm for $name\n";
	    return $rpm if ($name eq &get_rpm_name($rpm));
	}
    }
    return;
}

sub dirname {
    my @path= split('/',$_[0]);
    pop @path;
    return join('/',@path);
}


BEGIN {
#asm asm2
#jakarta-commons-beanutils-16 jakarta-commons-beanutils16
#jakarta-regexp regexp
#owanttask objectweb-anttask
#stylebook xml-stylebook
#xalan-j xalan-j2
#excalibur-logkit excalibur-avalon-logkit
#stax-bea bea-stax
our %ALT2JPPMAP=qw/
jakarta-commons-cli-1 jakarta-commons-cli
jakarta-servletapi4 servletapi4
wagon maven-wagon
jsvc jakarta-commons-daemon
/;

our %JPP2ALTMAP= reverse (%ALT2JPPMAP);

our @ALTSKIPDEPR=qw/tomcat4/;

our @ALTSKIPMULTISRPMS=qw/
xml-commons-external xml-commons-resolver
/;
#jakarta-commons-jelly-tags-ant
#jakarta-commons-jelly-tags-define
#jakarta-commons-jelly-tags-util
#jakarta-commons-jelly-tags-xml
#xml-commons xml-commons #xml-commons-external #xml-commons-resolver
##epoch+1
#xmldb-api
#isorelax

our @ALTSKIPNOJPP=qw/
drawswf
eclipse-build-utils
eclipse-cdt
eclipse-gef
jdbc-stdext
je
jed
jikes
jms
jmx
jndi
sax
servletapi5
trang
xsdlib
jaf
javamail
/;
#jaf classpathx-jaf ?
#javamail-1.3.1-alt2.src.rpm classpathx-mail?

our %ALTSKIP = map {$_=>1} @ALTSKIPMULTISRPMS, @ALTSKIPNOJPP, @ALTSKIPDEPR;

# done by damir
# hsqldb
#jakarta-commons-cli-2.0-alt0.1.src.rpm
#jakarta-commons-dbcp-1.2.2-alt0.1.src.rpm
#log4j
#struts-1.2.6-alt3.src.rpm

# alt imported packages (todo: refresh)
our @ALTPKG=qw/
antlr
asm
bcel
checkstyle
classworlds
drawswf
dom4j
eclipse-build-utils
eclipse-cdt
eclipse-gef
excalibur-logkit
forehead
geronimo-specs
isorelax
jaf
jakarta-commons-beanutils-16
jakarta-commons-beanutils
jakarta-commons-betwixt
jakarta-commons-cli
jakarta-commons-codec
jakarta-commons-collections
jakarta-commons-daemon
jakarta-commons-digester
jakarta-commons-discovery
jakarta-commons-el
jakarta-commons-fileupload
jakarta-commons-grant
jakarta-commons-graph
jakarta-commons-httpclient
jakarta-commons-io
jakarta-commons-jelly
jakarta-commons-jexl
jakarta-commons-lang
jakarta-commons-launcher
jakarta-commons-logging
jakarta-commons-modeler
jakarta-commons-net
jakarta-commons-pool
jakarta-commons-validator
jakarta-oro
jakarta-regexp
jakarta-servletapi4
jakarta-taglibs-standard
javacc
javamail
javassist
jaxen
jdbc-stdext
jdepend
jdom
je
jed
jikes
jline
jms
jmx
jndi
joesnmp
jsch
jtidy
junitperf
msv
mx4j
owanttask
relaxngDatatype
sax
snmptrapappender
stax-bea
stylebook
tomcat4
tomcat5
trang
wagon
werken-xpath
wsdl4j
ws-jaxme
xalan
xml-commons
xmldb-api
xmlunit
xpp2
xpp3
xsdlib
/;
}

